<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/rss2.xml" title="What a Chance to Learn" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="What a Chance to Learn">
<meta property="og:url" content="https://liuxu0703.github.io/index.html">
<meta property="og:site_name" content="What a Chance to Learn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="What a Chance to Learn">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://liuxu0703.github.io/"/>





  <title>What a Chance to Learn</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">What a Chance to Learn</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Lyux's Tech Blog</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://liuxu0703.github.io/2017/07/23/hexo-memo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lyux">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="What a Chance to Learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/23/hexo-memo/" itemprop="url">hexo 搭建备忘</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-23T01:09:47+08:00">
                2017-07-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/memo/" itemprop="url" rel="index">
                    <span itemprop="name">memo</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/23/hexo-memo/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2017/07/23/hexo-memo/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>备忘文档 (避免将来搬家时抓瞎), 简陋处望各位看客见谅.</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装:"></a>安装:</h2><p><strong>node.js:</strong>    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget -qO- https://raw.github.com/creationix/nvm/master/install.sh | sh</div></pre></td></tr></table></figure>
<p><strong>hexo:</strong>   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">apt-get install nvm</div><div class="line">nvm install stable</div><div class="line">npm install -g hexo-cli</div><div class="line">npm install hexo --save</div><div class="line"><span class="built_in">source</span> ~/.bashrc</div><div class="line"></div><div class="line">mkdir hexo_dir</div><div class="line"><span class="built_in">cd</span> hexo_dir</div><div class="line">hexo init</div><div class="line">npm install</div></pre></td></tr></table></figure>
<p><strong>theme:</strong>      </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> hexo_dir</div><div class="line">git <span class="built_in">clone</span> https://github.com/iissnan/hexo-theme-next.git themes/next</div><div class="line">git <span class="built_in">clone</span> https://github.com/litten/hexo-theme-yilia.git themes/yilia</div></pre></td></tr></table></figure>
<p><strong>plugin-RSS:</strong>    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install hexo-generator-feed --save</div></pre></td></tr></table></figure>
<p><strong>plugin-SiteMap (for SEO):</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install hexo-generator-sitemap --save</div></pre></td></tr></table></figure></p>
<h2 id="git-pages-部署配置"><a href="#git-pages-部署配置" class="headerlink" title="git pages 部署配置:"></a>git pages 部署配置:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git config --global user.name <span class="string">"liuxu"</span></div><div class="line">git config --global user.email <span class="string">"liuxu-0703@163.com"</span></div></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attr">deploy:</span></div><div class="line"><span class="attr">  type:</span> <span class="string">git</span></div><div class="line"><span class="attr">  repo:</span> <span class="string">git@github.com:liuxu0703/liuxu0703.github.io.git</span></div><div class="line"><span class="attr">  branch:</span> <span class="string">master</span></div></pre></td></tr></table></figure>
<hr>
<blockquote>
<p><a href="http://nodejs.org/" target="_blank" rel="external">nodejs official site</a><br><a href="https://hexo.io/zh-cn/" target="_blank" rel="external">hexo official site</a><br><a href="https://github.com/litten/hexo-theme-yilia" target="_blank" rel="external">hexo theme - yilia</a><br><a href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="external">hexo theme - next</a>     </p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://liuxu0703.github.io/2017/04/18/linux-move-home/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lyux">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="What a Chance to Learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/18/linux-move-home/" itemprop="url">linux 不改变目录结构移动 home 目录到新分区</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-18T10:23:11+08:00">
                2017-04-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/18/linux-move-home/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2017/04/18/linux-move-home/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="问题提出"><a href="#问题提出" class="headerlink" title="问题提出"></a>问题提出</h1><p>公司的开发测试服务器部署在阿里云, 阿里云给出的实例一般都是只有一个分区, 20G到40G的样子, 然后再买存储挂载到其他分区.<br>而 home 目录是在这个 20G 的跟目录分区下的. 随着开发人员增多, 根目录分区很快被大家填满了.<br>因为是多地研发, 因此需要一个无感知的给大家的 home 搬家的方案.</p>
<h1 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h1><p>接到这个任务, 首先想到的就是 bind mount 方式:</p>
<pre><code>mount --bind /some/where /else/where
</code></pre><p>可以实现无感知搬家 home.</p>
<blockquote>
<p>感觉搜索中文没有对这个命令解释太清除的. <a href="https://unix.stackexchange.com/questions/198590/what-is-a-bind-mount" target="_blank" rel="external">这篇问答</a> 讲的比较清楚, 英文好的同学可以参考下.<br>当然, 也可以问”男人”: <code>man mount</code></p>
</blockquote>
<h1 id="具体操作"><a href="#具体操作" class="headerlink" title="具体操作"></a>具体操作</h1><p>首先选个夜深人静的时候, 使用 <code>who</code> 命令查看还有那些小朋友赖在服务器不肯走, 打电话一一清场:</p>
<pre><code>$ who
Frodo    pts/0        2017-04-17 09:07 (xx.xxx.xxx.xx)
Sam      pts/1        2017-04-18 08:45 (xx.xxx.xxx.xx)
Pippin   pts/3        2017-04-18 09:06 (xx.xxx.xxx.xx)
Merry    pts/4        2017-04-18 09:07 (xx.xxx.xxx.xx)
</code></pre><p>确定四下无人后, 开始搬家(复制). 使用 cp 命令复制时, 记得带上 -p 参数, 保留文件权限设置. 使用 root 权限, 假设目标分区为 /new_disk :</p>
<pre><code># cp -p -r /home /new_disk/
</code></pre><p>新家已经建好, 我们先给老家弄个另外的门牌号, 以免把门牌号给新家后, 找不到老家了. 利用 mount –bind 把原 home 目录挂载到一个新目录:</p>
<pre><code># mkdir /home_bkp
# mount --bind /home /home_bkp
</code></pre><p>这时我们就可以在 /home_bkp 这个目录下找到老家的所有文件. 可以把 /home 这个门牌给新家了:</p>
<pre><code># mount --bind /new_disk/home /home
</code></pre><p>搬家完成! 可以通知小伙伴们愉快的工作了. 事实上, 可以不通知大家, 搬家这个事情对大家其实是无感知的.<br>当然有同学会问, 新家老家门牌一样, 都是 /home, 我怎么知道搬家是否成功? 可以使用 df 命令确认:</p>
<pre><code># cd /home_bkp
# df -h .
Filesystem      Size  Used Avail Use% Mounted on
/dev/xvda1       20G   17G  2.1G  90% /
# cd /home
# df -h .
Filesystem      Size  Used Avail Use% Mounted on
/dev/xvdb1      296G   42G  240G  15% /new_disk
</code></pre><p><code>-h</code> 为 human-readable, 不加的话也可以, 那列出的就是”反人类”的块为单位了.<br>上面的命令, 先去老家看看, 挂载点是 <code>/</code>; 再去新家看看, 挂载点是 <code>/new_disk</code>. 这下可以放心了.</p>
<h1 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h1><p>工作还没完. 上面的工作只是保证了当前新家换地址. 但重启后, 这个信息会丢失, 家地址会换回去. 我们需要想办法保留这个信息.<br>修改 <code>/etc/fstab</code> 文件即可. 打开这个文件, 在最后面加入下面两行:</p>
<pre><code>/home            /home_bkp  none  bind  0 0
/new_disk/home   /home      none  bind  0 0
</code></pre><p>这样整个 home 切换分区工作就完成了.</p>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>这个方案是心血来潮想出来的, 并没有找到前车之鉴, 不知道会不会有坑… 如有问题, 还望路过高手指点.<br>目前大家已经在新家工作了半年左右, 期间服务器也有过重启操作, 并未出现任何问题. 其实多数同事到现在也不知道发生过 home 搬家这件事.</p>
<hr>
<p>原创文章, 转载请注明出处. 原载 <a href="https://liuxu0703.github.io/">https://liuxu0703.github.io/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://liuxu0703.github.io/2017/04/18/memo-ubuntu-eclipse-tomcat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lyux">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="What a Chance to Learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/18/memo-ubuntu-eclipse-tomcat/" itemprop="url">Ubuntu + Eclipse + Tomcat 配置 Java Web 开发环境填坑笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-18T00:34:08+08:00">
                2017-04-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/memo/" itemprop="url" rel="index">
                    <span itemprop="name">memo</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/18/memo-ubuntu-eclipse-tomcat/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2017/04/18/memo-ubuntu-eclipse-tomcat/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>从 <a href="https://www.eclipse.org/downloads/download.php?file=/oomph/epp/neon/R3/eclipse-inst-linux64.tar.gz" target="_blank" rel="external">Eclipse 官网</a> 上下载到的 Eclipse Neon 是不带插件的, 要配置出一个 Java Web 开发环境, 尚需各种折腾. 把踩到的坑记录一下备忘.</p>
<h2 id="Eclipse-基本配置"><a href="#Eclipse-基本配置" class="headerlink" title="Eclipse 基本配置:"></a>Eclipse 基本配置:</h2><ul>
<li><p>使用 shadow sock 科学上网,需要配置代理: Window -&gt; Preferences -&gt; General -&gt; Network Connections</p>
</li>
<li><p>Help -&gt; Install New Software, 反选 “Contact all update sites during install to find required software”</p>
</li>
<li><p>配置 <a href="http://marketplace.eclipse.org/content/java-source-attacher" target="_blank" rel="external">Java Source Attacher</a>, 方便为各个库附加源码</p>
</li>
</ul>
<h2 id="Eclipse-插件"><a href="#Eclipse-插件" class="headerlink" title="Eclipse 插件:"></a>Eclipse 插件:</h2><p>Help -&gt; Install New Software 如下地址:</p>
<pre><code>http://download.eclipse.org/releases/neon/
</code></pre><p>选择安装如下插件:</p>
<pre><code>Web, XML, Java EE and OSGi Enterprise Development
Eclipse Java EE Developer Tools
Eclipse Java Web Developer Tools
Eclipse Web Developer Tools
JST Server Adapters
WST Server Adapters
m2e-wtp - Maven Integration for WTP
</code></pre><h2 id="Preference-中没有-Server-gt-Runtime-Environments-选项"><a href="#Preference-中没有-Server-gt-Runtime-Environments-选项" class="headerlink" title="Preference 中没有 Server -&gt; Runtime Environments  选项"></a>Preference 中没有 Server -&gt; Runtime Environments  选项</h2><p>需要安装 <code>JST Server Adapters</code> 和 <code>JST Server Adapters Extentions</code> . 步骤:</p>
<ol>
<li>Help -&gt; Install New Software</li>
<li>选择 <code>Neon - http://download.eclipse.org/releases/neon</code></li>
<li>Expand “Web, XML, and Java EE Development”</li>
<li>找到并勾选 JST Server Adapters</li>
</ol>
<blockquote>
<p>参考: <a href="http://stackoverflow.com/questions/2000078/apache-tomcat-not-showing-in-eclipse-server-runtime-environments" target="_blank" rel="external">stackoverflow_question</a></p>
</blockquote>
<h2 id="配置-Server-gt-Runtime-Environments"><a href="#配置-Server-gt-Runtime-Environments" class="headerlink" title="配置 Server -&gt; Runtime Environments"></a>配置 Server -&gt; Runtime Environments</h2><ol>
<li>Windows → Preferences -&gt; Server -&gt; Runtime Environments</li>
<li>点击 “Add”, 选择要运行的 tomcat 版本, Next</li>
<li>配置 tomcat 路径. 用 <code>apt-get install</code> 安装的 tomcat 这个路径配置 <code>/usr/share/tomcat7/</code></li>
<li>“OK”, “Finish”</li>
</ol>
<blockquote>
<p>参考: <a href="https://askubuntu.com/questions/350448/configure-tomcat-in-eclipse" target="_blank" rel="external">askubuntu_setup_runtime_environment</a></p>
</blockquote>
<h2 id="Eclipse-底部没有-Servers-窗口"><a href="#Eclipse-底部没有-Servers-窗口" class="headerlink" title="Eclipse 底部没有 Servers 窗口"></a>Eclipse 底部没有 Servers 窗口</h2><p>手动添加:<br>Windows -&gt; Show View -&gt; Other -&gt; 查找 servers -&gt; OK</p>
<h2 id="Ubuntu-Tomcat-路径"><a href="#Ubuntu-Tomcat-路径" class="headerlink" title="Ubuntu Tomcat 路径"></a>Ubuntu Tomcat 路径</h2><p>如果是用 <code>apt-get install tomcat7</code> 安装, 重要路径有:</p>
<pre><code>/etc/tomcat{X} for configuration
/usr/share/tomcat{X} for runtime, called CATALINA_HOME
/usr/share/tomcat{X}-root for webapps
/var/lib/tomcat{X}
</code></pre><p>如果 tomcat 在 eclipse 中始终无法启动, 尝试如下命令:</p>
<pre><code>cd /usr/share/tomcat7
sudo ln -s /var/lib/tomcat7/conf conf
sudo ln -s /etc/tomcat7/policy.d/03catalina.policy conf/catalina.policy
sudo ln -s /var/log/tomcat7 logs
sudo ln -s /var/lib/tomcat7/webapps webapps
sudo chmod -R 777 /usr/share/tomcat7/conf
</code></pre><p>可用如下命令查看 tomcat 的安装目录:</p>
<pre><code>dpkg -L tomcat7
</code></pre><blockquote>
<p>参考: <a href="https://askubuntu.com/questions/135824/what-is-the-tomcat-installation-directory" target="_blank" rel="external">askubuntu_tomcat_directory</a></p>
</blockquote>
<p>经过如上配置, Eclipse 中的 Windows -&gt; Preferences -&gt; Tomcat 设置中可将 Tomcat 路径配置为 <code>/usr/share/tomcat7</code></p>
<h2 id="Eclipse-Tomcat-plugin-安装"><a href="#Eclipse-Tomcat-plugin-安装" class="headerlink" title="Eclipse Tomcat plugin 安装"></a>Eclipse Tomcat plugin 安装</h2><p>Help -&gt; Install New Software<br><a href="http://tomcatplugin.sf.net/update" target="_blank" rel="external">http://tomcatplugin.sf.net/update</a></p>
<h2 id="项目-web-deployment-assembly-配置-maven-依赖"><a href="#项目-web-deployment-assembly-配置-maven-依赖" class="headerlink" title="项目 web deployment assembly 配置 maven 依赖"></a>项目 web deployment assembly 配置 maven 依赖</h2><p>运行项目时遇到下面问题:</p>
<pre><code>SEVERE: Error configuring application listener of class org.springframework.web.context.ContextLoaderListener
java.lang.ClassNotFoundException: org.springframework.web.context.ContextLoaderListener
</code></pre><p>解决:</p>
<ol>
<li>右击项目名称并在弹出菜单中选择 “Properties”.</li>
<li>选择 “Deployment Assembly”.</li>
<li>点击 “Add…”.</li>
<li>在  Directive Type 菜单中选择 “Java Build Path Entries”, 点击 “Next”.</li>
<li>在  Java Build Path Entries 菜单中选择 “Maven Dependencies”, 点击 “Finish”.</li>
</ol>
<blockquote>
<p>参考: <a href="http://stackoverflow.com/questions/6210757/java-lang-classnotfoundexception-org-springframework-web-context-contextloaderl" target="_blank" rel="external">stackoverflow_question</a></p>
</blockquote>
<h2 id="Eclipse-Console-Log-写入本地文件"><a href="#Eclipse-Console-Log-写入本地文件" class="headerlink" title="Eclipse Console Log 写入本地文件"></a>Eclipse Console Log 写入本地文件</h2><p>Run -&gt; Run Configurations -&gt; Tomcat Server -&gt; Common -&gt; Standard Input and Output -&gt; Output File<br>在输入框内填入一个本地文件地址即可. 比如 /tmp/my_project_console_log<br>未来就可以愉快的使用 <code>tail -f /tmp/my_project_console_log</code> 在命令行看 log 了.</p>
<h2 id="禁止-tomcat-开机自启"><a href="#禁止-tomcat-开机自启" class="headerlink" title="禁止 tomcat 开机自启"></a>禁止 tomcat 开机自启</h2><pre><code>update-rc.d -f tomcat7 remove
</code></pre><h2 id="Eclipse-自动代码提示配置"><a href="#Eclipse-自动代码提示配置" class="headerlink" title="Eclipse 自动代码提示配置"></a>Eclipse 自动代码提示配置</h2><p>Windows -&gt; Preferences -&gt; Java -&gt; Editor -&gt; Content Assist</p>
<p>AutoActivation Delay 改为 20<br>Auto Activation triggers for java 改为 .abcdefghijklmnopqrstuvwxyz(,</p>
<h2 id="Eclipse-格式化代码配置"><a href="#Eclipse-格式化代码配置" class="headerlink" title="Eclipse 格式化代码配置"></a>Eclipse 格式化代码配置</h2><p>Windows -&gt; Preferences -&gt; Java -&gt; Code Style -&gt; Formatter</p>
<p>格式化代码快捷键 Shift + Ctrl + F</p>
<h2 id="Eclipse-Customize-Perspective-StackOverflowError"><a href="#Eclipse-Customize-Perspective-StackOverflowError" class="headerlink" title="Eclipse Customize Perspective StackOverflowError"></a>Eclipse Customize Perspective StackOverflowError</h2><p>想要配置 toolbar , 打开 Windows -&gt; Perspective -&gt; Customize Perspective<br>Eclipse 提示遇到问题, 原因是 StackOverflowError.</p>
<blockquote>
<p>参考: <a href="http://stackoverflow.com/questions/41983135/eclipse-neon-customize-perspective-provokes-a-stackoverflowerror" target="_blank" rel="external">stackoverflow_question</a></p>
</blockquote>
<h2 id="wget-下载-JDK"><a href="#wget-下载-JDK" class="headerlink" title="wget 下载 JDK"></a>wget 下载 JDK</h2><p>写这个是因为这里有个坑, 用 wget 不带参数直接下载 JDK 会失败. 步骤:<br>首先到官网找到最新的 <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank" rel="external">JDK 下载地址</a>, 找到需要的 JDK 后, 记得先点 “Accept License Agreement”, 再复制下载链接才能复制的到.</p>
<p>有了下载地址, 使用 <code>wget</code> 命令下载 JDK 时需要加一些参数才可以成功:</p>
<pre><code>wget --no-check-certificate --no-cookies --header &quot;Cookie: oraclelicense=accept-securebackup-cookie&quot; http://download.oracle.com/otn-pub/java/jdk/8u112-b15/jdk-8u112-linux-x64.rpm
</code></pre><p>把上面的 JDK 下载地址换成你想要的 JDK 地址就可以了.</p>
<blockquote>
<p>参考: <a href="http://stackoverflow.com/questions/10268583/downloading-java-jdk-on-linux-via-wget-is-shown-license-page-instead" target="_blank" rel="external">download_jdk_with_wget</a></p>
</blockquote>
<hr>
<p>原创文章, 转载请注明出处. 原载 <a href="https://liuxu0703.github.io/">https://liuxu0703.github.io/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://liuxu0703.github.io/2017/04/12/activity-TintContextWrapper-cannot-be-cast-to/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lyux">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="What a Chance to Learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/12/activity-TintContextWrapper-cannot-be-cast-to/" itemprop="url">Android 从 View 中获取 Activity 时遇到 TintContextWrapper cannot be cast to 的问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-12T00:36:32+08:00">
                2017-04-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/12/activity-TintContextWrapper-cannot-be-cast-to/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2017/04/12/activity-TintContextWrapper-cannot-be-cast-to/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述:"></a>问题描述:</h1><p>如果一个 View 绘制于某个 Activity 的 ContentView 上, 那它的 Context 一定是和这个 Activity 相关联的. 因此我们想在 View 中直接用 Activity 方法时 (最常用的应该就是 Activity.startActivity() 方法了), 不必再向 View 中传递 Activity 对象.<br>一般在 View 中获取这个 Activity 对象都是简单的用下面代码就可以了:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Activity activity = (Activity) getContext();</div></pre></td></tr></table></figure></p>
<p>但在 View 继承自 AppCompat 系的 View 时 (比如 AppCompatTextView, AppCompatImageView), 上面方法可能会得到下面异常:</p>
<pre><code>**java.lang.ClassCastException: android.support.v7.widget.TintContextWrapper cannot be cast to ...Activity**
</code></pre><h1 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因:"></a>问题原因:</h1><p>原因其实很简单. 上 AppCompatTextView 的构造函数代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppCompatTextView</span> <span class="keyword">extends</span> <span class="title">TextView</span> <span class="keyword">implements</span> <span class="title">TintableBackgroundView</span> </span>&#123;</div><div class="line"></div><div class="line">    ......</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppCompatTextView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppCompatTextView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, attrs, android.R.attr.textViewStyle);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppCompatTextView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(TintContextWrapper.wrap(context), attrs, defStyleAttr);  <span class="comment">// 注意这行</span></div><div class="line"></div><div class="line">        mBackgroundTintHelper = <span class="keyword">new</span> AppCompatBackgroundHelper(<span class="keyword">this</span>);</div><div class="line">        mBackgroundTintHelper.loadFromAttributes(attrs, defStyleAttr);</div><div class="line"></div><div class="line">        mTextHelper = AppCompatTextHelper.create(<span class="keyword">this</span>);</div><div class="line">        mTextHelper.loadFromAttributes(attrs, defStyleAttr);</div><div class="line">        mTextHelper.applyCompoundDrawablesTints();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ......</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在构造函数中, context 被用 <code>TintContextWrapper</code> 包了一层. 所以这时 Activity 其实被保存在了 <code>TintContextWrapper</code> 中的 BaseContext 中了.<br>即 <code>TintContextWrapper</code> 不能直接强制转换为 Activity.</p>
<blockquote>
<p>网上有说 23.3.0 的 v7 之后的包中会有这个问题, 之前的不会. 我手头只有 25.3.0 的源码, 没有验证其他版本的代码是什么样子. 不过这不重要, 因为下面的解决方案可以兼容各个情况.</p>
</blockquote>
<h1 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决:"></a>问题解决:</h1><p>知道原因就简单了. 可以简单的用 <code>TintContextWrapper.getBaseContext()</code> 得到这个 Activity.<br>但其实一层层的从 ContextWrapper 中把 Activity 剥出来更保险:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * try get host activity from view.</div><div class="line"> * views hosted on floating window like dialog and toast will sure return null.</div><div class="line"> * <span class="doctag">@return</span> host activity; or null if not available</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Activity <span class="title">getActivityFromView</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">    Context context = view.getContext();</div><div class="line">    <span class="keyword">while</span> (context <span class="keyword">instanceof</span> ContextWrapper) &#123;</div><div class="line">        <span class="keyword">if</span> (context <span class="keyword">instanceof</span> Activity) &#123;</div><div class="line">            <span class="keyword">return</span> (Activity) context;</div><div class="line">        &#125;</div><div class="line">        context = ((ContextWrapper) context).getBaseContext();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如上方法可以通用的解决从 View 中获取 Activity 的问题.</p>
<p>事实上, 谷歌 v7 包中的 <code>android.support.v7.app.MediaRouteButton</code> 就是这么干的.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考:"></a>参考:</h1><p><a href="http://stackoverflow.com/questions/8276634/android-get-hosting-activity-from-a-view/32973351#32973351" target="_blank" rel="external">Android get hosting Activity from a view</a></p>
<hr>
<p>原创文章, 转载请注明出处. 原载 <a href="https://liuxu0703.github.io/">https://liuxu0703.github.io/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://liuxu0703.github.io/2017/04/06/android-screen-record-gif/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lyux">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="What a Chance to Learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/06/android-screen-record-gif/" itemprop="url">bash 实现一键录制 Android 屏幕为 GIF</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-06T17:10:33+08:00">
                2017-04-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bash/" itemprop="url" rel="index">
                    <span itemprop="name">bash</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/06/android-screen-record-gif/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2017/04/06/android-screen-record-gif/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h1><p><strong>编写 bash 脚本, 实现一行命令得到 Android 手机录制屏幕 gif 动图文件.</strong></p>
<p>博主使用 ubuntu 系统, shell 为 bash. 这个脚本也可以用在 mac 系统上.<br>听说 windows 系统出了 <a href="https://msdn.microsoft.com/en-us/commandline/wsl/about" target="_blank" rel="external">ubuntu on windows</a>, 不知道能不能使用这个脚本.</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><h2 id="adb-shell-screenrecord"><a href="#adb-shell-screenrecord" class="headerlink" title="adb shell screenrecord"></a>adb shell screenrecord</h2><p>Android 4.4 版本后系统内预置了一个 screenrecord 命令, 可以用来将屏幕录制为 MP4 格式. 具体命令格式可以通过 –help 参数查看:</p>
<pre><code>$ adb shell screenrecord --help
Usage: screenrecord [options] &lt;filename&gt;

Android screenrecord v1.2.  Records the device&apos;s display to a .mp4 file.

Options:
--size WIDTHxHEIGHT
    Set the video size, e.g. &quot;1280x720&quot;.  Default is the device&apos;s main
    display resolution (if supported), 1280x720 if not.  For best results,
    use a size supported by the AVC encoder.
--bit-rate RATE
    Set the video bit rate, in bits per second.  Value may be specified as
    bits or megabits, e.g. &apos;4000000&apos; is equivalent to &apos;4M&apos;.  Default 4Mbps.
--bugreport
    Add additional information, such as a timestamp overlay, that is helpful
    in videos captured to illustrate bugs.
--time-limit TIME
    Set the maximum recording time, in seconds.  Default / maximum is 180.
--verbose
    Display interesting information on stdout.
--help
    Show this message.

Recording continues until Ctrl-C is hit or the time limit is reached.
</code></pre><p>举例:</p>
<pre><code>adb shell screenrecord --size &quot;360x640&quot; --bit-rate 2000000 /sdcard/android_screenrecord_test.mp4
</code></pre><p>上面的命令将把所连接的手机屏幕录制为 宽高 360x640, 比特率 2M 的视频, 保存为手机 sd 卡根目录下的 android_screenrecord_test.mp4 文件.<br>该命令会持续录制, 直到用 ctrl-c 终止命令, 那么录制也就结束了.<br>也可以用 –time-limit TIME 参数来预先指定录制时长, 到时间会自动结束. 默认的最大时长为 3 分钟.</p>
<h2 id="ffmpeg"><a href="#ffmpeg" class="headerlink" title="ffmpeg"></a>ffmpeg</h2><p>使用 ffmpeg 抽帧的命令将视频提取为一系列图片:</p>
<pre><code>ffmpeg -i video.mp4 -r 5 &apos;frames/frame-%03d.jpg&apos;
</code></pre><p>其中: <code>-r 5</code> 代表抽取的帧率, 即每秒视频抽取 5 帧出来.</p>
<h2 id="convert"><a href="#convert" class="headerlink" title="convert"></a>convert</h2><p>使用 imagemagick 包中的 convert 命令将一系列图片组合为 gif 动图格式:</p>
<pre><code>convert -delay 20 -loop 0 *.jpg myimage.gif
</code></pre><p>其中: <code>-delay 20</code> 代表所生成的 gif 动图每帧之间的时间间隔, 即每 0.2 秒显示下一帧.</p>
<blockquote>
<p>如果系统内还没有 convert 命令, 可以用如下命令安装:<br><code>sudo apt-get install imagemagick</code><br>博主使用 ubuntu 16.10, 这个命令是预置在系统里的, 不需要安装.</p>
</blockquote>
<h2 id="ffmpeg-及-convert-参数设置"><a href="#ffmpeg-及-convert-参数设置" class="headerlink" title="ffmpeg 及 convert 参数设置"></a>ffmpeg 及 convert 参数设置</h2><p>上面两个命令中, <code>ffmpeg -r 5</code> 和 <code>convert -delay 20</code> 这两个参数值, 分别是 视频抽帧间隔 和 gif每帧间隔, 假设其分别为 video_fps 和 gif_delay, 那么这两个参数在设置时必须满足如下条件:<br><code>video_fps * gif_delay = 100</code></p>
<p>如果乘积小于 100, 则生成的 gif 会比原本的播放速度快;<br>如果乘积大于 100, 则生成的 gif 会比原本的播放速度慢.</p>
<p>至于原因, 结合上面对这两个参数的介绍, 思考一下就明白了.</p>
<h2 id="捕获录制结束事件"><a href="#捕获录制结束事件" class="headerlink" title="捕获录制结束事件"></a>捕获录制结束事件</h2><p>上面三个命令分开调用, 实现录屏为 gif 已经相当简单了.<br>如果要将三条命令写在一个脚本里, 在一个过程中完成功能, 第一个要解决的是如何捕获录制结束事件, 即 ctrl-c 命令.<br>在 bash 中可以通过下面脚本实现:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># catch ctrl-c signal</span></div><div class="line"><span class="function"><span class="title">CTRL_C</span></span>() &#123;</div><div class="line">    <span class="comment"># ctrl-c hit, do something</span></div><div class="line">&#125;</div><div class="line"><span class="built_in">trap</span> CTRL_C SIGINT</div></pre></td></tr></table></figure>
<p>有了这个方法获取录制结束事件, 再往下就简单了.<br>这里遇到一个坑, 就是如果捕获 ctrl-c 后直接开始转换 gif 的操作, 会失败. 试过几次后, 发现是 ctrl-c 后其实 Android 的 screenrecord 命令并没有处理完, 这时候的视频还不可用. 解决的办法简单粗暴, 让脚本原地 sleep 2秒, 再去操作所生成的 MP4 文件就可用了.</p>
<h1 id="最终脚本"><a href="#最终脚本" class="headerlink" title="最终脚本"></a>最终脚本</h1><p>也不知道该写些啥了, 直接贴出完整脚本吧:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment"># author : liuxu-0703@163.com</span></div><div class="line"></div><div class="line"><span class="comment">#========================================================</span></div><div class="line"><span class="comment"># define param group here</span></div><div class="line"></div><div class="line">QUALITY_1=(<span class="string">"360x640"</span>  1000000  4  25)</div><div class="line">QUALITY_2=(<span class="string">"360x640"</span>  1000000  5  20)</div><div class="line">QUALITY_3=(<span class="string">"360x640"</span>  1000000  10  10)</div><div class="line">QUALITY_4=(<span class="string">"720x1280"</span>  1000000  4  25)</div><div class="line">QUALITY_5=(<span class="string">"720x1280"</span>  1000000  5  20)</div><div class="line"></div><div class="line"><span class="comment">#========================================================</span></div><div class="line"></div><div class="line">QUALITY=(<span class="variable">$&#123;QUALITY_2[@]&#125;</span>)</div><div class="line"></div><div class="line">RESOLUTION=<span class="variable">$&#123;QUALITY[0]&#125;</span></div><div class="line">BIT_RATE=<span class="variable">$&#123;QUALITY[1]&#125;</span></div><div class="line">GIF_FPS=<span class="variable">$&#123;QUALITY[2]&#125;</span></div><div class="line">GIF_DELAY=<span class="variable">$&#123;QUALITY[3]&#125;</span></div><div class="line"></div><div class="line"><span class="comment"># GIF_FPS and GIF_DELAY must meet the following condition:</span></div><div class="line"><span class="comment"># GIF_FPS * GIF_DELAY = 100</span></div><div class="line"></div><div class="line">OUTPUT_FILE_NAME=android_screen_record.$(date +%m%d%H%M%S).gif</div><div class="line">OUTPUT_FILE_DIR=$(<span class="built_in">pwd</span>)</div><div class="line">OUTPUT_VIDEO_NAME=screenrecord_$(date +%m%d%H%M%S).mp4</div><div class="line">OUTPUT_VIDEO_DEVICE_DIR=/sdcard</div><div class="line">TMP_DIR=/tmp/android_screen_to_gif_$(date +%m%d%H%M%S)</div><div class="line"></div><div class="line">RECORDING=<span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment"># you may use adb by absolute file path. if so, specify it here</span></div><div class="line">ADB=<span class="string">"adb"</span></div><div class="line"></div><div class="line"><span class="comment">#========================================================</span></div><div class="line"></div><div class="line"><span class="comment"># catch ctrl-c signal</span></div><div class="line"><span class="function"><span class="title">CTRL_C</span></span>() &#123;</div><div class="line">    <span class="keyword">if</span> <span class="variable">$RECORDING</span>; <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"stop recording. start convert..."</span></div><div class="line">        RECORDING=<span class="literal">false</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="comment"># ctrl-c hit but not for stop recording, just exit.</span></div><div class="line">        <span class="built_in">exit</span> $?</div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    <span class="comment"># adb screenrecord may still deal with mp4 file creating,</span></div><div class="line">    <span class="comment"># just wait for it a little while.</span></div><div class="line">    sleep 2s</div><div class="line">    adb pull <span class="variable">$OUTPUT_VIDEO_DEVICE_DIR</span>/<span class="variable">$OUTPUT_VIDEO_NAME</span> <span class="variable">$TMP_DIR</span></div><div class="line">    <span class="keyword">if</span> [ -f <span class="variable">$TMP_DIR</span>/<span class="variable">$OUTPUT_VIDEO_NAME</span> ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"converting file: <span class="variable">$TMP_DIR</span>/<span class="variable">$OUTPUT_VIDEO_NAME</span>"</span></div><div class="line">        MP4ToGIF <span class="variable">$TMP_DIR</span>/<span class="variable">$OUTPUT_VIDEO_NAME</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"* create screen record mp4 fail"</span></div><div class="line">        <span class="built_in">exit</span> 2</div><div class="line">    <span class="keyword">fi</span></div><div class="line">&#125;</div><div class="line"><span class="built_in">trap</span> CTRL_C SIGINT</div><div class="line"></div><div class="line"><span class="comment"># catch script exit event</span></div><div class="line"><span class="function"><span class="title">CLEAR_WORK</span></span>() &#123;</div><div class="line">    <span class="keyword">if</span> [ -e <span class="variable">$TMP_DIR</span> ]; <span class="keyword">then</span></div><div class="line">        <span class="comment"># since the tmp files have been put into /tmp/ dir, they will get</span></div><div class="line">        <span class="comment"># removed on system reboot. thus we are in no hurry to remove them now.</span></div><div class="line">        <span class="comment"># un-commit this line if you want to remove tmp files immediately after script run</span></div><div class="line">        <span class="comment">#rm $TMP_DIR</span></div><div class="line">        <span class="built_in">echo</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line">&#125;</div><div class="line"><span class="built_in">trap</span> <span class="string">"CLEAR_WORK"</span> EXIT</div><div class="line"></div><div class="line"><span class="comment">#========================================================</span></div><div class="line"></div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">MP4ToGIF</span></span>() &#123;</div><div class="line">    <span class="built_in">echo</span> <span class="string">"*** extract frames ***"</span></div><div class="line">    mkdir <span class="variable">$TMP_DIR</span>/frames</div><div class="line">    ffmpeg -i <span class="variable">$1</span> -r <span class="variable">$GIF_FPS</span> <span class="string">"<span class="variable">$TMP_DIR</span>/frames/frame-%03d.jpg"</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"*** convert frames to gif ***"</span></div><div class="line">    convert -delay <span class="variable">$GIF_DELAY</span> -loop 0 <span class="string">"<span class="variable">$TMP_DIR</span>/frames/*.jpg"</span> <span class="variable">$OUTPUT_FILE_DIR</span>/<span class="variable">$OUTPUT_FILE_NAME</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#========================================================</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [ ! -d <span class="string">"<span class="variable">$OUTPUT_FILE_DIR</span>"</span> ]; <span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"* output dir not exists: <span class="variable">$OUTPUT_FILE_DIR</span>"</span></div><div class="line">    <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">if</span> [ ! -e <span class="variable">$TMP_DIR</span> ]; <span class="keyword">then</span></div><div class="line">    mkdir <span class="variable">$TMP_DIR</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">if</span> [ ! -e <span class="variable">$TMP_DIR</span> ]; <span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"* tmp dir not exists: <span class="variable">$TMP_DIR</span>"</span></div><div class="line">    <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"params: <span class="variable">$RESOLUTION</span>, <span class="variable">$BIT_RATE</span>, <span class="variable">$GIF_FPS</span>, <span class="variable">$GIF_DELAY</span>"</span></div><div class="line">adb shell screenrecord --verbose --size <span class="variable">$RESOLUTION</span> --bit-rate <span class="variable">$BIT_RATE</span> <span class="variable">$OUTPUT_VIDEO_DEVICE_DIR</span>/<span class="variable">$OUTPUT_VIDEO_NAME</span></div></pre></td></tr></table></figure>
<p>开头定义的那几个数组, 是为了便于测试. 最终生成的 gif 文件也直接保存在了当前目录下.<br>主要是因为加上参数化, 代码会多很多, 就不容易找到主要功能了.<br>带参数化, 带简易帮助文档的完整脚本, 可以在下面链接中找到:</p>
<p><a href="https://github.com/liuxu0703/lx_bash_script/blob/master/android_script/android_screen2gif.sh" target="_blank" rel="external">android_screen2gif.sh</a></p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>使用前提:</p>
<ul>
<li>adb 可以正常连接到手机, 就是不能有 offline 之类的问题. 这里安利另一篇文章: <a href="http://blog.csdn.net/liuxu0703/article/details/60956006" target="_blank" rel="external">解决 ubuntu adb 设备识别问题</a></li>
<li>手机必须是 4.4 以上系统.</li>
</ul>
<p>脚本本身就是为了使用简单写的. 只需在命令行直接敲入脚本名执行即可开始手机屏幕录制. 因为是测试, 选择在 /tmp 目录操作.</p>
<pre><code>$ cd /tmp/
$ android_screen2gif.sh 
params: 360x640, 1000000, 5, 20
Main display is 720x1280 @60.00fps (orientation=0)
Configuring recorder for 360x640 video/avc at 1.00Mbps
Content area is 360x640 at offset x=0 y=0
</code></pre><p> 这时命令行是挂起的, 等你认为录制可以结束了, 按下 ctrl-c, 录制结束, 开始转换 gif 的步骤. 一般需要3到4秒, 录屏的 gif 就在当前目录生成了.</p>
<pre><code>^Cstop recording. start convert...
[100%] /sdcard/screenrecord_0407090859.mp4
converting file: /tmp/android_screen_to_gif_0407090859/screenrecord_0407090859.mp4
*** extract frames ***
ffmpeg version 3.0.7-0ubuntu0.16.10.1 Copyright (c) 2000-2017 the FFmpeg developers
......
Input #0, mov,mp4,m4a,3gp,3g2,mj2, from &apos;/tmp/android_screen_to_gif_0407090859/screenrecord_0407090859.mp4&apos;:
......
Output #0, image2, to &apos;/tmp/android_screen_to_gif_0407090859/frames/frame-%03d.jpg&apos;:
......
*** convert frames to gif ***
result gif file:
/tmp/android_screen_record.0407090859.gif
</code></pre><p>这一步输出较多, 用 <code>......</code> 代替了部分输出. 最后那行就是最终生成的 gif 录屏文件了.</p>
<h1 id="参数建议"><a href="#参数建议" class="headerlink" title="参数建议"></a>参数建议</h1><p>根据自测 及 最终 gif 生成的过程, 可以得到如下结论:</p>
<p><strong>视频解析度参数:</strong></p>
<ul>
<li>宽高越大越清晰, 最终生成的 gif 文件越大. 这个是很明显的.</li>
<li>最好按手机竖屏显示的方式, 将解析度设置为 9:16 的比例. 如果设置为其他比例, 比如 480:480, 则录制出的视频会有很宽的黑边.</li>
</ul>
<p><strong>视频比特率参数:</strong><br>先说结论: 比特率设置基本不会影响最终生成的 gif 文件质量.<br>因为最终 gif 文件来自视频抽帧, 视频比特率的大小对于比如每秒抽取10帧这样的需求, 对抽取出的图片清晰度影响不大. 因此为了中间文件更小, 建议把这个参数设低即可.</p>
<p><strong>抽帧帧率 及 每帧间隔:</strong><br>这两个参数对最终 gif 质量影响很大. 其中:<br>抽帧帧率越大, 最终 gif 质量越高;<br>每帧间隔越小, 最终 gif 质量越高.<br>如前述, 这两个参数必须成对设置. 如果这两个参数都取整数的话, 基本上可以设置的就下面这几对:</p>
<pre><code>2, 50
4, 25
5, 20
10, 10
</code></pre><p>其中:<br>10, 10 这组, 设置每秒10帧, gif 每帧间隔 0.1 秒, 这样5秒的gif文件就要大概 10M 大小了.<br>2, 50 这组, 设置每秒2帧, gif 每帧间隔 0.5 秒, 最终gif文件卡顿就很严重了.<br>因此建议选取 <code>5, 20</code> 这组参数. 如果觉得卡顿, 再试试 <code>10, 10</code> 这组.</p>
<p>综上, 大家可以自己尝试下设置不同的参数组合, 试几次就能体会该怎么设置了.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考:"></a>参考:</h1><blockquote>
<p><a href="http://askubuntu.com/questions/648603/create-animated-gif-from-mp4-video-via-command-line" target="_blank" rel="external">create gif from mp4 via command line</a><br><a href="http://www.imagemagick.org/Usage/anim_basics/" target="_blank" rel="external">command convert doc</a></p>
</blockquote>
<hr>
<p>原创文章, 转载请注明出处. 原载 <a href="https://liuxu0703.github.io/">https://liuxu0703.github.io/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://liuxu0703.github.io/2017/03/30/vsftpd-blank-page-announimous-user/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lyux">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="What a Chance to Learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/30/vsftpd-blank-page-announimous-user/" itemprop="url">vsftpd 匿名用户登录显示空白页问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-30T00:40:10+08:00">
                2017-03-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/30/vsftpd-blank-page-announimous-user/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2017/03/30/vsftpd-blank-page-announimous-user/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#问题:</p>
<p>本来内网 ftp 用的好好的, 突然某天匿名用户就无法通过浏览器访问 ftp 了.</p>
<p>#尝试解决:</p>
<p>##检查 vsftpd 配置:<br>出现这个问题首先肯定要查看 vsftpd 配置. 我使用 CentOS 6.5, 这个配置文件位置如下:</p>
<pre><code>/etc/vsftpd/vsftpd.conf
</code></pre><p>重点检查如下两个参数设置是否正确:</p>
<pre><code>anonymous_enable=YES
anon_root=/ftp_public
</code></pre><p>第一个参数为是否允许匿名用户登录 ftp;<br>第二个参数为匿名用户登入后显示的目录, 也是其可以浏览的根目录.</p>
<p>检查的结果是, 木有问题…</p>
<p>##检查 selinux 配置:</p>
<p>然后怀疑 selinux 配置是否被人改了. 敲入如下命令:</p>
<pre><code>$ getsebool -a | grep ftp
allow_ftpd_anon_write --&gt; off
allow_ftpd_full_access --&gt; on
allow_ftpd_use_cifs --&gt; off
allow_ftpd_use_nfs --&gt; off
ftp_home_dir --&gt; on
ftpd_connect_db --&gt; off
ftpd_use_fusefs --&gt; off
ftpd_use_passive_mode --&gt; on
httpd_enable_ftp_server --&gt; off
tftp_anon_write --&gt; off
tftp_use_cifs --&gt; off
tftp_use_nfs --&gt; off
</code></pre><p>看起来也木有问题. 也尝试把某些参数打开, 但没有效果.</p>
<blockquote>
<p>设置打开某项 selinux 配置命令: <code>setsebool allow_ftpd_full_access on</code><br>ftp 出现疑似权限问题时, 可以查看并尝试打开某些 selinux 选项.</p>
</blockquote>
<p>selinux 还有一个目录权限相关的配置. 尝试执行如下命令:</p>
<pre><code>chcon -R -t public_content_t /ftp_public
</code></pre><p>chcon 用于修改某对象的安全上下文. 上面那句就是说, 设置要把某目录对匿名用户 (nobody) 开放.<br>但就这个问题来说, 这个方法也没能解决问题…</p>
<p>##检查目录权限:</p>
<p>然后开始怀疑是 ftp_public 目录权限问题. <code>ls -al</code> 查看发现该目录权限为 777. 这个权限已经是最大了, 应该也没问题.</p>
<p>#最终原因:</p>
<p>各种方法无果, 开始找谷歌帮忙. 浏览并尝试了各种解决方案, 最终在 <a href="http://www.linuxquestions.org/questions/linux-server-73/ftp-220-vsftpd-2-0-5-dir-list-not-visible-922809-print/" target="_blank" rel="external">这个帖子</a> 里面找到了解决我问题的方案:</p>
<p><strong>把 ftp_public 目录权限由 777 改为 755</strong> , 问题解决.</p>
<p>这估计是哪位兄弟图省事, 为了达成某个功能, 而把这个目录直接赋予了最大权限. 没想到最大权限反而有问题.<br>看帖子中提到的原因, 是说 <strong>配置中匿名用户没有写权限, 因此匿名用户无法登录到有写权限的目录中</strong>.</p>
<p>另一个碰到过的类似的例子是, 给 git 配置的 <code>~/.ssh/id_rsa.pub</code> 公钥文件不可以具有执行权限, 否则 git 会认为该公钥是无效的.</p>
<p>这两个故事教育我们, linux 文件权限绝不是大就可用, 除非明确知道自己要做什么, 否则不要给文件赋予 777 权限.</p>
<hr>
<p>原创文章, 转载请注明出处. 原载 <a href="https://liuxu0703.github.io/">https://liuxu0703.github.io/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://liuxu0703.github.io/2017/03/23/fragment-getFragment-null/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lyux">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="What a Chance to Learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/23/fragment-getFragment-null/" itemprop="url">Android 保存 Fragment 引用及 getActivity() 为空问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-23T00:42:37+08:00">
                2017-03-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/23/fragment-getFragment-null/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2017/03/23/fragment-getFragment-null/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#问题</p>
<p>做 Android 应用开发的小伙伴们大多都被 Fragment 坑过. 最近研究了其中常见的一种坑, 记录下来, 以免遗忘. 问题大体是这样的:<br>有时我们希望在 Activity 中保存所创建的 Fragment 的引用, 以便后续逻辑中做界面更新等操作. 如果页面中的 Fragment 都是静态的 (不会被 remove, hide 等), 则一般不会出啥问题. 如果是多个 Fragment 切换的场景, 就容易出现 getActivity() 为 null 等问题. 这种问题在使用 FragmentPagerAdapter 时尤其容易出现.<br>这里涉及两个问题: Fragment 的创建和 Fragment 引用的保存. 两个问题都有坑.</p>
<p>先放结论 (编程建议):</p>
<ol>
<li>不要在 Activity.onCreate() 中直接 <code>new Fragment()</code>. Fragment 的创建应尽量纳入 FragmentManager 的管理.</li>
<li>尽量不要保存 Fragment 的引用. 在需要直接调用 Fragment 时, 使用 FragmentManager.findFragmentByTag() 等方法获取相关 Fragment 的引用.</li>
<li>如果一定要保存 Fragment 引用, 则要谨慎选择获取引用的节点.</li>
</ol>
<p>#原因分析</p>
<p>以一段实际代码说明.<br>遇到主页需要左右滑动切换标签页的需求, 最常用的就是 ViewPager + FragmePagerAdapter 方案了. 很多小伙伴可能会这样写 (示例代码1):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TabChangeActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ArrayList&lt;Fragment&gt; mFragmentList;</div><div class="line">    <span class="keyword">private</span> ViewPager mViewPager;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_tab_fragment_sample);</div><div class="line">        mFragmentList = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">3</span>);</div><div class="line">        mFragmentList.add(<span class="keyword">new</span> Fragment1());</div><div class="line">        mFragmentList.add(<span class="keyword">new</span> Fragment2());</div><div class="line">        mFragmentList.add(<span class="keyword">new</span> Fragment3());</div><div class="line">        mViewPager = (ViewPager) findViewById(R.id.view_pager);</div><div class="line">        mViewPager.setAdapter(<span class="keyword">new</span> SlidePagerAdapter(getSupportFragmentManager()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">SlidePagerAdapter</span> <span class="keyword">extends</span> <span class="title">FragmentPagerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SlidePagerAdapter</span><span class="params">(FragmentManager fm)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(fm);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Fragment <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> mFragmentList.get(position);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> mFragmentList.size();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上例是一个最简单的标签页切换界面写法, 布局中只有一个 ViewPager, 就不再贴出了.<br>但这段代码是存在隐患的.<br>这里首先复习一下 Activity 管理 Fragment 的方式. 在代码中动态显示 Fragment 时, 大体流程如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showFragment1</span><span class="params">()</span> </span>&#123;</div><div class="line">    FragmentManager fragmentManager = getSupportFragmentManager();</div><div class="line">    FragmentTransaction transaction = fragmentManager.beginTransaction();</div><div class="line">    <span class="comment">// 查看 fragment1 是否已经被添加</span></div><div class="line">    Fragment1 fragment1 = (Fragment1) fragmentManager.findFragmentByTag(<span class="string">"fragment1"</span>);</div><div class="line">    <span class="keyword">if</span> (fragment1 == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// fragment1 尚未被添加, 则创建并添加</span></div><div class="line">        fragment1 = <span class="keyword">new</span> Fragment1();</div><div class="line">        transaction.add(R.id.submitter_fragment_container, fragment1, <span class="string">"fragment1"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// fragment1 已被添加, 则调用 show() 方法让其显示</span></div><div class="line">        transaction.show(fragment1);</div><div class="line">    &#125;</div><div class="line">    transaction.commit();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但 示例代码1 中并没有类似逻辑. 其实是被 FragmentPagerAdapter 封装了, 但逻辑依然是一样的:<br>FragmentPagerAdapter 在需要展示 fragment1 时, 会首先尝试通过 <code>FragmentManager.findFragmentByTag()</code> 找到它. 如果找不到, 才会调用 <code>FragmentPagerAdapter.getItem()</code> 来创建它.</p>
<p>回到 示例代码1, 在正常情况下, 这段代码是可以完美运行的. 但如果我们的界面被系统回收掉了, 当用户再次返回这个界面时, 问题就来了. 在这种情况下:</p>
<ul>
<li>因为 Activity 被销毁了, 因此 onCreate() 会被调用, 我们的三个 Fragment 会被重新创建并装入 mFragmentList 数组.</li>
<li>又因为 Activity 被销毁了, 因此系统会自动恢复界面状态, <strong>包括之前已经被添加的 Fragment</strong>. 恢复完成后, 轮到 FragmentPagerAdapter 显示 fragment1. FragmentPagerAdapter 通过 <code>FragmentManager.findFragmentByTag()</code>, 发现 fragment1 已经被添加了 (被添加的为老 Fragment, 即被系统恢复的那个). 因此不会再去调用 <code>FragmentPagerAdapter.getItem()</code>, 因此 <strong>FragmentPagerAdapter 直接显示了被系统恢复出来的 fragment1</strong>.</li>
</ul>
<p>没错, 这种情况下, Fragment1 在 Activity 中其实有两个实例:<br>一个是真正的被 Activity 添加并显示的实例;<br>一个是在 onCreate() 中被创建, 并保存在 mFragmentList 中的<strong>没有什么卵用</strong>的实例.</p>
<p>可以想见, 这种状态下肯定会出现很多莫名其妙的问题, 其中就包括 <code>getActivity()</code> 返回 null 的问题.</p>
<blockquote>
<p>吐槽: <code>FragmentPagerAdapter.getItem()</code> 方法明明就是 FragmentPagerAdapter 用来内部创建 Fragment 用的啊, 根本不是用来供外部获取 Fragment 用的. 如果改名叫 <code>createItem()</code> 或者 <code>createFragment()</code> 之类的, 估计可以防止不少人掉坑的.</p>
</blockquote>
<p>#代码修正</p>
<p>基于以上分析可知, 在 <code>Activity.onCreate()</code> 中创建 Fragment 是不恰当的. 应该把 Fragment 的创建放在 <code>FragmentPagerAdapter.getItem()</code> 中. 经过改进的 示例代码1 如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TabChangeActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ViewPager mViewPager;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_tab_fragment_sample);</div><div class="line">        mViewPager = (ViewPager) findViewById(R.id.view_pager);</div><div class="line">        mViewPager.setAdapter(<span class="keyword">new</span> SlidePagerAdapter(getSupportFragmentManager()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">SlidePagerAdapter</span> <span class="keyword">extends</span> <span class="title">FragmentPagerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SlidePagerAdapter</span><span class="params">(FragmentManager fm)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(fm);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Fragment <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (position) &#123;</div><div class="line">                <span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Fragment1();</div><div class="line">                <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Fragment2();</div><div class="line">                <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Fragment3();</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// unlikely to happen</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">3</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>即: 不再用 mFragmentList 保存各个 Fragment 的引用了, Fragment 的创建完全交给 FragmentPagerAdapter 去做.<br>其实在其他的使用 Fragment 的场景中, 也会出现上述问题, 也应该遵循同样的原则, 即文章开头所列的 建议1 和 建议2 .</p>
<p>这样是解决了上面提到的 Activity 销毁恢复的问题, 但如果我们在 Activity 逻辑中, 一定要取到 Fragment 引用, 该怎么办呢. (比如, 点击 ActionBar 上的按钮则改变 Fragment 中的某段文字).<br>有两种方法可以解决保存 Fragment 引用的问题.</p>
<p>#保存引用</p>
<p>如前所述, 肯定不能用 <code>FragmentPagerAdapter.getItem()</code> 方法来获取!<br>要找到合适的方法, 需要瞄一眼源码. FragmentPagerAdapter 的源码相当的短:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FragmentPagerAdapter</span> <span class="keyword">extends</span> <span class="title">PagerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">    ......</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">instantiateItem</span><span class="params">(ViewGroup container, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mCurTransaction == <span class="keyword">null</span>) &#123;</div><div class="line">            mCurTransaction = mFragmentManager.beginTransaction();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> itemId = getItemId(position);</div><div class="line"></div><div class="line">        <span class="comment">// Do we already have this fragment?</span></div><div class="line">        String name = makeFragmentName(container.getId(), itemId);</div><div class="line">        Fragment fragment = mFragmentManager.findFragmentByTag(name);</div><div class="line">        <span class="keyword">if</span> (fragment != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Attaching item #"</span> + itemId + <span class="string">": f="</span> + fragment);</div><div class="line">            mCurTransaction.attach(fragment);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            fragment = getItem(position);</div><div class="line">            <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Adding item #"</span> + itemId + <span class="string">": f="</span> + fragment);</div><div class="line">            mCurTransaction.add(container.getId(), fragment,</div><div class="line">                    makeFragmentName(container.getId(), itemId));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (fragment != mCurrentPrimaryItem) &#123;</div><div class="line">            fragment.setMenuVisibility(<span class="keyword">false</span>);</div><div class="line">            fragment.setUserVisibleHint(<span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> fragment;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ......</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">makeFragmentName</span><span class="params">(<span class="keyword">int</span> viewId, <span class="keyword">long</span> id)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"android:switcher:"</span> + viewId + <span class="string">":"</span> + id;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面只列出了其中的两个关键方法:<br><code>instantiateItem()</code> 方法是负责创建 pager 页的方法, 其逻辑就是先判断 Fragment 是否存在, 存在则显示, 不存在则调用 <code>getItem(position)</code> 创建.<br><code>makeFragmentName()</code> 方法用来为一个特定位置的 fragment 生成一个 tag, 规则就是容器 ViewGroup 的 id 和 Fragment 位置的组合. 其中 ViewGroup 的 id 就是 ViewPager 在 Activity 界面中的 id.</p>
<p>因此取到 Fragment 引用的方法也就找到了:</p>
<p>##方法一</p>
<p>既然我们都知道 tag 的生成规则了, 找到 Fragment 那还不是 so easy.<br>还是以上面的 示例代码1 为例, 获取 fragment1 的引用, 这么做就可以了:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">changeFragment1Text</span><span class="params">()</span> </span>&#123;</div><div class="line">    String tag = <span class="string">"android:switcher:"</span> + R.id.view_pager + <span class="string">":"</span> + <span class="number">0</span>;</div><div class="line">    Fragment1 fragment1 = (Fragment1) getSupportFragmentManager().findFragmentByTag(tag);</div><div class="line">    <span class="comment">// 一定要做判空, 因为你要找的 Fragment 这时可能还没有加入 Activity 中.</span></div><div class="line">    <span class="keyword">if</span> (fragment1 != <span class="keyword">null</span>) &#123;</div><div class="line">        fragment1.setText(<span class="string">"Laziness is a programmer's feature."</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        Log.e(<span class="string">"lyux"</span>, <span class="string">"fragment not added yet."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这种方法有两个缺点:<br>一是, tag 的规则依赖一个源码中的私有方法, 谷歌大大哪天不爽要改了这条规则, 我们的程序就会出错了.<br>二是, 对于另一个装载 Fragment 的 PagerAdapter, 即 <code>FragmentStatePagerAdapter</code>, 这个方法是不适用的.</p>
<blockquote>
<p><code>FragmentStatePagerAdapter</code> 是为了懒加载及页面回收的目的而编写的, 即不把每个 page 页的内容都保存在内存里. 因此它在创建了 Fragment 后, 没有给其附加 tag. 所以由它创建的 Fragment 无法用 <code>FragmentManager.findFragmentByTag()</code> 方法找到. 具体见其源码, 也不长.</p>
</blockquote>
<p>##方法二</p>
<p>还有一种思路, 是重载 FragmentPagerAdapter 类中的 <code>instantiateItem()</code> 方法, 得到 Fragment 引用. 依然以 示例代码1 为例, 将 SlidePagerAdapter 做如下改写即可:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TabChangeActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ViewPager mViewPager;</div><div class="line">    <span class="keyword">private</span> Fragment1 mFragment1;</div><div class="line">    <span class="keyword">private</span> Fragment2 mFragment2;</div><div class="line">    <span class="keyword">private</span> Fragment3 mFragment3;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_tab_fragment_sample);</div><div class="line">        mViewPager = (ViewPager) findViewById(R.id.view_pager);</div><div class="line">        mViewPager.setAdapter(<span class="keyword">new</span> SlidePagerAdapter(getSupportFragmentManager()));</div><div class="line"></div><div class="line">        <span class="comment">// 延迟5秒改变文字. 如果立刻执行, mFragment1 肯定是 null.</span></div><div class="line">        <span class="keyword">new</span> Handler().postDelayed(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (mFragment1 != <span class="keyword">null</span>) &#123;</div><div class="line">                    mFragment1.setText(<span class="string">"Every program must have a purpose. If not, it is deleted. -- The Matrix"</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;, <span class="number">5000</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">SlidePagerAdapter</span> <span class="keyword">extends</span> <span class="title">FragmentPagerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SlidePagerAdapter</span><span class="params">(FragmentManager fm)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(fm);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Fragment <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (position) &#123;</div><div class="line">                <span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Fragment1();</div><div class="line">                <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Fragment2();</div><div class="line">                <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Fragment3();</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// unlikely to happen</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">3</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">instantiateItem</span><span class="params">(ViewGroup container, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            Fragment fragment = (Fragment) <span class="keyword">super</span>.instantiateItem(container, position);</div><div class="line">            <span class="keyword">switch</span> (position) &#123;</div><div class="line">                <span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">                    mFragment1 = (Fragment1) fragment;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">                    mFragment2 = (Fragment2) fragment;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">                    mFragment3 = (Fragment3) fragment;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> fragment;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为 <code>instantiateItem()</code> 方法管理了 Fragment 的创建及重用, 因此无论其是新创建的, 还是被恢复的, 都可以正确取到引用.</p>
<blockquote>
<p><strong>注意:</strong> 不要在 <code>FragmentStatePagerAdapter</code> 场景中使用该方法. 因为我们保存了每一页的 Fragment 的引用, 就会阻止其被回收, 那 FragmentStatePagerAdapter 就白用了: 不就是为了可以回收页面才用它的嘛.<br>真要用的话就用 <code>WeakReference&lt;Fragment&gt;</code> 保存其弱引用.<br>但据说 4.0 后的 Android 虚拟机中弱引用等于没引用, 会很快被回收掉. (没深入研究过 JVM, 这句是听一位虚拟机大牛说的)</p>
</blockquote>
<hr>
<p>原创文章, 转载请注明出处. 原载 <a href="https://liuxu0703.github.io/">https://liuxu0703.github.io/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://liuxu0703.github.io/2017/03/15/android-activity-style/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lyux">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="What a Chance to Learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/15/android-activity-style/" itemprop="url">Android 多主题切换 (theme + style) 及 selector/drawable 无法引用 ?attr 属性的问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-15T23:23:11+08:00">
                2017-03-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/15/android-activity-style/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2017/03/15/android-activity-style/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#需求:</p>
<p>最近需要实现应用内多主题的需求: 要求应用内预置 10 个左右的主题配色方案, 用户可按需切换.<br>刚一拿到需求, 觉得这简单, 用 Android 的 theme + style 就可以搞定了. 没过多久就遇到了 attr 无法被 selector, drawable 等 xml 资源引用的大坑.<br>主题色切换的方案中文网络上一搜一大堆, 但没有哪位博主好心的提起这里还有这么深一个坑的…<br>这里先把解决方案简要叙述一下.</p>
<p>#Android 预置多主题解决方案:</p>
<p><strong>首先定义主题配色相关属性, 我将之单独写在 values/style_themes_attrs.xml 里.</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"color_bkg_main"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"color_action_bar"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"color_action_bar_text"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"color_primary"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"color_primary_pressed"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"color_primary_disabled"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"color_text"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"color_text_pressed"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"color_text_disabled"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"color_text_sub"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"color_text_hint"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"color_divider"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这些属性是应用全局的, 为便于引用, 不应该写在 <code>&lt;declare-styleable&gt;</code> 标签里.</p>
<p><strong>然后定义各个主题配色的具体颜色值 (即给以上属性赋值), 我将之单独写在 values/style_themes.xml 里.</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"theme_default"</span> <span class="attr">parent</span>=<span class="string">"BaseAppTheme"</span>&gt;</span><span class="xml"></span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"color_bkg_main"</span>&gt;</span>#f1f1f1<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"color_action_bar"</span>&gt;</span>#ee9c18<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"color_action_bar_text"</span>&gt;</span>#fff<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"color_primary"</span>&gt;</span>#ee9c18<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"color_primary_pressed"</span>&gt;</span>#80ee9c18<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"color_primary_disabled"</span>&gt;</span>#666<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"color_text"</span>&gt;</span>#202020<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"color_text_pressed"</span>&gt;</span>#80202020<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"color_text_disabled"</span>&gt;</span>#666<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"color_text_sub"</span>&gt;</span>#717171<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"color_text_hint"</span>&gt;</span>#b6b6b6<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"color_divider"</span>&gt;</span>#e2e2e2<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"theme_sky"</span> <span class="attr">parent</span>=<span class="string">"theme_default"</span>&gt;</span><span class="xml"></span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"color_action_bar"</span>&gt;</span>#02a8f3<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"color_primary"</span>&gt;</span>#02a8f3<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"color_primary_pressed"</span>&gt;</span>#8002a8f3<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"theme_grass"</span> <span class="attr">parent</span>=<span class="string">"theme_default"</span>&gt;</span><span class="xml"></span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"color_action_bar"</span>&gt;</span>#63d64a<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"color_primary"</span>&gt;</span>#63d64a<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"color_primary_pressed"</span>&gt;</span>#8063d64a<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>theme_default 继承的 BaseAppTheme 是接到此需求前就已经在 AndroidManifest.xml 中赋值给 App 的 theme. 这个不重要, 你也可以继承系统自带的一些主题, 也可以不继承任何主题, 与实现需求关系不大, 怎么方便怎么来就成.<br>下面两个主题 theme_sky 和 theme_grass 继承自 theme_default , 这样做是为了不至于重复给颜色属性赋值, 比如文字颜色在这三个主题中是一样的, 继承了就可以避免再写一遍.<br>注意: 要想在 App 全局使用主题属性, 就必须保证每个 style 内的各个属性都是全的. 比如 theme_grass 里如果没有 color_primary 这个属性, 那么有代码引用这个属性时将发生异常. 注意是运行时异常哦~, 编译时不会报错的. 因此稳妥的做法还是写一个 base style , 然后其他 style 继承之, 这样起码不会崩溃.</p>
<p><strong>最后将主题颜色属性用于各个View.</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:background</span>=<span class="string">"?attr/color_bkg_main"</span></div><div class="line">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span> &gt;</div><div class="line"></div><div class="line">        ......</div><div class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>或者省略 attr/ 也是可以的:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:textSize</span>=<span class="string">"16sp"</span></div><div class="line">    <span class="attr">android:textColor</span>=<span class="string">"?color_text"</span></div><div class="line">    <span class="attr">android:text</span>=<span class="string">"Text Normal"</span> /&gt;</div></pre></td></tr></table></figure></p>
<p><strong>最最后, 就是动态切换主题的代码了.</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> lx.af.demo.activity.test;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.app.Activity;</div><div class="line"><span class="keyword">import</span> android.content.res.Resources;</div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"><span class="keyword">import</span> android.support.annotation.AttrRes;</div><div class="line"><span class="keyword">import</span> android.support.annotation.ColorInt;</div><div class="line"><span class="keyword">import</span> android.util.TypedValue;</div><div class="line"><span class="keyword">import</span> android.view.View;</div><div class="line"></div><div class="line"><span class="keyword">import</span> lx.af.demo.R;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * author: lx</div><div class="line"> * date: 17-2-24</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThemeChangeActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> sCurrentTheme = R.style.theme_default;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line"></div><div class="line">        <span class="comment">// 这句必须放在 setContentView() 之前, 否则不生效.</span></div><div class="line">        <span class="comment">// 一般的做法是把这句话放在你的 BaseActivity 里面.</span></div><div class="line">        setTheme(sCurrentTheme);</div><div class="line"></div><div class="line">        setContentView(R.layout.activity_change_theme);</div><div class="line">        findViewById(R.id.btn_switch_theme_default).setOnClickListener(<span class="keyword">this</span>);</div><div class="line">        findViewById(R.id.btn_switch_theme_sky).setOnClickListener(<span class="keyword">this</span>);</div><div class="line">        findViewById(R.id.btn_switch_theme_grass).setOnClickListener(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 演示如何用代码获取 attr 定义的主题相关的颜色</span></div><div class="line">        View primaryColorPanel = findViewById(R.id.primary_color_panel);</div><div class="line">        primaryColorPanel.setBackgroundColor(getCurrentPrimaryColor());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (view.getId()) &#123;</div><div class="line">            <span class="keyword">case</span> R.id.btn_switch_theme_sky:</div><div class="line">                changeTheme(R.style.theme_sky);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.btn_switch_theme_grass:</div><div class="line">                changeTheme(R.style.theme_grass);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.btn_switch_theme_default:</div><div class="line">                changeTheme(R.style.theme_default);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">changeTheme</span><span class="params">(<span class="keyword">int</span> theme)</span> </span>&#123;</div><div class="line">        <span class="comment">// 改变主题时应该把当前主题设置保存进 SharedPreferences 里去.</span></div><div class="line">        <span class="comment">// 比如给这三个主题编号 101, 102, 103, 然后保存该编号, 供下次启动时设置为对应主题.</span></div><div class="line">        <span class="comment">// 这里省略了这部分逻辑, 只留主题相关逻辑.</span></div><div class="line">        sCurrentTheme = theme;</div><div class="line">        </div><div class="line">        <span class="comment">// 调用 Activity.recreate() 方法即可从 Activity.onCreate() 开始重新加载界面.</span></div><div class="line">        <span class="comment">// 该方法不会启动界面过场动画, 但重启时会有一下闪烁.</span></div><div class="line">        recreate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 直接获取主题的主色颜色值</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCurrentPrimaryColor</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> getColorByAttributeId(R.attr.color_primary);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 使用代码获取主题属性颜色值的方法</span></div><div class="line">    <span class="meta">@ColorInt</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getColorByAttributeId</span><span class="params">(@AttrRes <span class="keyword">int</span> attrIdForColor)</span></span>&#123;</div><div class="line">        TypedValue typedValue = <span class="keyword">new</span> TypedValue();</div><div class="line">        Resources.Theme theme = getTheme();</div><div class="line">        theme.resolveAttribute(attrIdForColor, typedValue, <span class="keyword">true</span>);</div><div class="line">        <span class="keyword">return</span> typedValue.data;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个 Activity 对应的布局文件如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:background</span>=<span class="string">"?attr/color_bkg_main"</span></div><div class="line">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span> &gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_switch_theme_sky"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"45dp"</span></div><div class="line">        <span class="attr">android:layout_marginLeft</span>=<span class="string">"10dp"</span></div><div class="line">        <span class="attr">android:layout_marginRight</span>=<span class="string">"10dp"</span></div><div class="line">        <span class="attr">android:layout_marginTop</span>=<span class="string">"10dp"</span></div><div class="line">        <span class="attr">android:background</span>=<span class="string">"?attr/color_primary"</span></div><div class="line">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></div><div class="line">        <span class="attr">android:textColor</span>=<span class="string">"#fff"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"change theme sky"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_switch_theme_grass"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"45dp"</span></div><div class="line">        <span class="attr">android:layout_marginLeft</span>=<span class="string">"10dp"</span></div><div class="line">        <span class="attr">android:layout_marginRight</span>=<span class="string">"10dp"</span></div><div class="line">        <span class="attr">android:layout_marginTop</span>=<span class="string">"10dp"</span></div><div class="line">        <span class="attr">android:background</span>=<span class="string">"?attr/color_primary"</span></div><div class="line">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></div><div class="line">        <span class="attr">android:textColor</span>=<span class="string">"#fff"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"change theme grass"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_switch_theme_default"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"45dp"</span></div><div class="line">        <span class="attr">android:layout_marginLeft</span>=<span class="string">"10dp"</span></div><div class="line">        <span class="attr">android:layout_marginRight</span>=<span class="string">"10dp"</span></div><div class="line">        <span class="attr">android:layout_marginTop</span>=<span class="string">"10dp"</span></div><div class="line">        <span class="attr">android:background</span>=<span class="string">"?attr/color_primary"</span></div><div class="line">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></div><div class="line">        <span class="attr">android:textColor</span>=<span class="string">"#fff"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"change theme default"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_marginLeft</span>=<span class="string">"10dp"</span></div><div class="line">        <span class="attr">android:layout_marginRight</span>=<span class="string">"10dp"</span></div><div class="line">        <span class="attr">android:layout_marginTop</span>=<span class="string">"10dp"</span></div><div class="line">        <span class="attr">android:padding</span>=<span class="string">"25dp"</span></div><div class="line">        <span class="attr">android:background</span>=<span class="string">"?attr/color_primary"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span> &gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:textSize</span>=<span class="string">"16sp"</span></div><div class="line">            <span class="attr">android:textColor</span>=<span class="string">"?attr/color_text"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"Text Normal"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:textSize</span>=<span class="string">"16sp"</span></div><div class="line">            <span class="attr">android:textColor</span>=<span class="string">"?attr/color_text_pressed"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"Text pressed"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:textSize</span>=<span class="string">"16sp"</span></div><div class="line">            <span class="attr">android:textColor</span>=<span class="string">"?attr/color_text_sub"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"Text sub"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:textSize</span>=<span class="string">"16sp"</span></div><div class="line">            <span class="attr">android:textColor</span>=<span class="string">"?attr/color_text_hint"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"Text hint"</span> /&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">FrameLayout</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/primary_color_panel"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></div><div class="line">        <span class="attr">android:layout_marginLeft</span>=<span class="string">"10dp"</span></div><div class="line">        <span class="attr">android:layout_marginRight</span>=<span class="string">"10dp"</span></div><div class="line">        <span class="attr">android:layout_marginTop</span>=<span class="string">"10dp"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这样就解决了多主题的问题. 新加入一个主题也非常简单, 只要继承 theme_default, 复写一些颜色值就可以了.<br><strong>下面开始掉坑.</strong></p>
<p>#坑!</p>
<p>此坑很凌乱, 各种资源对象在各个版本表现都不一样. 但成坑原因其实基本一致. 大体就是, xml 资源中 (比如 drawable) 如果引用了 attr 定义的颜色, 再引用该 xml 资源时都有可能有问题. 我们暂且称此类资源为 attr-xml 资源.</p>
<blockquote>
<p><strong>注意:</strong> 因为手头最低版本的设备为 Android 4.1.2 (API level 16), 最高为 Android 7.0 (API level 24), 超出这个范围就没有实测了.</p>
</blockquote>
<p>##AppCompat</p>
<p>在 Android 6.0 (API level 23) 以下设备上, 如果 Activity 不是继承自 v23.0 以上的 AppCompat 包中的 <code>AppCompatActivity</code> 的话, 使用 attr-xml 资源可能出现各种奇怪问题.<br>比如 ColorStateList 的 xml 资源在最终显示时会被渲染为<strong>红色</strong>.<br>因为解决办法很简单, 所以不对由此产生的各种问题再做具体讨论了.</p>
<p><strong>解决办法:</strong><br>举例, 比如有以下 ColorStateList 资源 <code>res/color/color_selector_primary.xml</code>:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">selector</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:state_pressed</span>=<span class="string">"true"</span> <span class="attr">android:color</span>=<span class="string">"?attr/color_primary_pressed"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:state_enabled</span>=<span class="string">"false"</span> <span class="attr">android:color</span>=<span class="string">"?attr/color_primary_disabled"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:color</span>=<span class="string">"?attr/color_primary"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">selector</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>被 TextView 的 <code>android:textColor=@color/color_selector_primary</code> 引用就会渲染为红色字体.</p>
<p>方法1: Activity 继承 AppCompatActivity 就可以了 (v7兼容库版本大于 v23.0).<br><code>compile &#39;com.android.support:appcompat-v7:25.2.0&#39;</code><br><code>public class ThemeChangeActivity extends AppCompatActivity { ... }</code></p>
<p>方法2: 改为使用相关的兼容库控件, 比如 TextView 改为 AppCompatTextView:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.v7.widget.AppCompatTextView</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/btn_switch_theme_grass"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"45dp"</span></div><div class="line">    <span class="attr">android:layout_marginLeft</span>=<span class="string">"10dp"</span></div><div class="line">    <span class="attr">android:layout_marginRight</span>=<span class="string">"10dp"</span></div><div class="line">    <span class="attr">android:layout_marginTop</span>=<span class="string">"10dp"</span></div><div class="line">    <span class="attr">android:gravity</span>=<span class="string">"center"</span></div><div class="line">    <span class="attr">android:textColor</span>=<span class="string">"@color/color_selector_primary"</span></div><div class="line">    <span class="attr">android:text</span>=<span class="string">"change theme grass"</span> /&gt;</div></pre></td></tr></table></figure></p>
<p>很显然, 第一种方法更简单. 除了 dialog 等少数地方不能用这个方法解决, 其他地方用继承 AppCompatActivity 的方法解决最方便. 第二种方法还得逐个改.<br>下文中的讨论都是在 Activity 已经继承了 AppCompatActivity 的基础上进行的.</p>
<p>##background</p>
<p>这个才是真坑…<br>上面讲为了 <code>android:textColor</code> 属性设置 selector (ColorStateList), 但其实我们更常用的是为 <code>android:background</code> 属性设置 selector. 而 background 只能接受 drawable 类型的 selector.<br>举例, 有如下 selector 类型的 drawable <code>res/drawable/selector_primary.xml</code>:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">selector</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:state_pressed</span>=<span class="string">"true"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">shape</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">solid</span> <span class="attr">android:color</span>=<span class="string">"?attr/color_primary_pressed"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">shape</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">shape</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">solid</span> <span class="attr">android:color</span>=<span class="string">"?attr/color_primary"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">shape</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">selector</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>在 Android 5.0 (API level 21) 以下机器上, drawable xml 资源中引用 attr , 如果在 layout 布局中引用这样的 drawable 资源, 则会引发崩溃. 以下为截取的崩溃 trace 中的片段:</p>
<pre><code>03-14 11:21:30.092  4920  4920 E AndroidRuntime: Caused by: java.lang.UnsupportedOperationException: Can&apos;t convert to color: type=0x2
03-14 11:21:30.092  4920  4920 E AndroidRuntime:     at android.content.res.TypedArray.getColor(TypedArray.java:326)
03-14 11:21:30.092  4920  4920 E AndroidRuntime:     at android.graphics.drawable.GradientDrawable.inflate(GradientDrawable.java:951)
03-14 11:21:30.092  4920  4920 E AndroidRuntime:     at android.graphics.drawable.Drawable.createFromXmlInner(Drawable.java:895)
03-14 11:21:30.092  4920  4920 E AndroidRuntime:     at android.graphics.drawable.StateListDrawable.inflate(StateListDrawable.java:183)
03-14 11:21:30.092  4920  4920 E AndroidRuntime:     at android.graphics.drawable.Drawable.createFromXmlInner(Drawable.java:895)
03-14 11:21:30.092  4920  4920 E AndroidRuntime:     at android.graphics.drawable.Drawable.createFromXml(Drawable.java:828)
03-14 11:21:30.092  4920  4920 E AndroidRuntime:     at android.content.res.Resources.loadDrawable(Resources.java:1933)
03-14 11:21:30.092  4920  4920 E AndroidRuntime:     ... 31 more
</code></pre><p>博主目前暂未找到解决该问题的办法. 如有好的方法, 还请指点.<br>因此只能尝试绕过, 方式是在代码中手动组装 ColorStateList, Drawable 等可用做 background 背景的资源.</p>
<p>ColorStateList 可以这么组装:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">private static ColorStateList createColorStateList(Context context) &#123;</div><div class="line">  return new ColorStateList(</div><div class="line">      new int[][]&#123;</div><div class="line">          new int[]&#123;android.R.attr.state_pressed&#125;, // pressed state.</div><div class="line">          StateSet.WILD_CARD,                      // other state.</div><div class="line">      &#125;,</div><div class="line">      new int[]&#123;</div><div class="line">          getThemeAttrColor(context, R.attr.color_primary_pressed),  // pressed state.</div><div class="line">          getThemeAttrColor(context, R.attr.color_primary),          // other state.</div><div class="line">      &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>drawable 可以这么组装:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Drawable <span class="title">createDrawableSelector</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    StateListDrawable stateDrawable = <span class="keyword">new</span> StateListDrawable();</div><div class="line">    GradientDrawable normalDrawable = <span class="keyword">new</span> GradientDrawable();</div><div class="line">    GradientDrawable pressedDrawable = <span class="keyword">new</span> GradientDrawable();</div><div class="line">    GradientDrawable disabledDrawable = <span class="keyword">new</span> GradientDrawable();</div><div class="line"></div><div class="line">    <span class="keyword">int</span>[][] states = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">4</span>][];</div><div class="line">    states[<span class="number">0</span>] = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;android.R.attr.state_enabled, android.R.attr.state_pressed&#125;;</div><div class="line">    states[<span class="number">1</span>] = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;android.R.attr.state_enabled, android.R.attr.state_focused&#125;;</div><div class="line">    states[<span class="number">3</span>] = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;-android.R.attr.state_enabled&#125;; <span class="comment">// disabled state</span></div><div class="line">    states[<span class="number">2</span>] = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;android.R.attr.state_enabled&#125;;</div><div class="line"></div><div class="line">    <span class="comment">// 为各种状态下的 drawable 设置 attr 颜色值</span></div><div class="line">    normalDrawable.setColor(getColorByAttrId(context, R.attr.color_primary));</div><div class="line">    pressedDrawable.setColor(getColorByAttrId(context, R.attr.color_primary_pressed));</div><div class="line">    disabledDrawable.setColor(getColorByAttrId(context, R.attr.color_primary_disabled));</div><div class="line"></div><div class="line">    <span class="comment">// 为各种状态下的 drawable 设置圆角等属性. 仅举一例, 不详述.</span></div><div class="line">    normalDrawable.setCornerRadius(<span class="number">5</span>);</div><div class="line">    pressedDrawable.setCornerRadius(<span class="number">5</span>);</div><div class="line">    disabledDrawable.setCornerRadius(<span class="number">5</span>);</div><div class="line"></div><div class="line">    stateDrawable.addState(states[<span class="number">0</span>], pressedDrawable);</div><div class="line">    stateDrawable.addState(states[<span class="number">1</span>], pressedDrawable);</div><div class="line">    stateDrawable.addState(states[<span class="number">3</span>], disabledDrawable);</div><div class="line">    stateDrawable.addState(states[<span class="number">2</span>], normalDrawable);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> stateDrawable;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@ColorInt</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getColorByAttrId</span><span class="params">(Context context, @AttrRes <span class="keyword">int</span> attrIdForColor)</span> </span>&#123;</div><div class="line">    TypedValue typedValue = <span class="keyword">new</span> TypedValue();</div><div class="line">    Resources.Theme theme = context.getTheme();</div><div class="line">    theme.resolveAttribute(attrIdForColor, typedValue, <span class="keyword">true</span>);</div><div class="line">    <span class="keyword">return</span> typedValue.data;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>把这种由代码生成的 drawable 通过 <code>View.setBackground(Drawable background)</code> 方法设置, 效果即可生效.<br>可以据此封装一些常用控件出来, 比如 TextView, 以简化相关工作.<br>但 workaround 的解决方案, 无论怎么简化, 都是比较恶心的.</p>
<blockquote>
<p>文末 <a href="http://www.androiddesignpatterns.com/2016/08/contextcompat-getcolor-getdrawable.html" target="_blank" rel="external">大神的文章</a> 中提到, 使用 6.0 的矢量图 (vector drawable, 可通过 AppCompat 包向下兼容) 可以不受此问题影响, 可以解决 drawable 引用 attr 颜色问题. 这个没有实测. 因为即使这种方法可用, 博主也没有时间将所有 drawable xml 全部改为矢量图 (会被 UI 打死的).<br>小伙伴们有兴趣也可以试下这种方法.</p>
</blockquote>
<p>#原因:</p>
<p>不关心起因的同学可略过此节.<br>简单来说, 这个问题是 API &lt; 21 的系统中, Resources.getColor() 方法没有接收 theme 参数导致的.<br>在 Android 5.0 以下, 我们在代码中获取颜色值, 只能用这个方法:<br><code>Resoueces.getColor(@ColorRes int id)</code><br>上面那条语句在 5.0 以上的SDK, android studio (lint) 会给我们一条警告, 告诫我们方法已 Deprecated, 建议使用下面的方法:<br><code>Resources.getColor(@ColorRes int id, @Nullable Theme theme)</code><br>ContextCompat 类中也提供了一个兼容的方法:<br><code>ContextCompat.getColor(Context context, @ColorRes int id)</code></p>
<p>这个方法最终就是在调用类似下面的罗辑 (之所以说 “类似”, 是因为各版本的兼容包略有不同):<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) &#123;</div><div class="line">  <span class="keyword">return</span> context.getResources().getColor(id, context.getTheme());</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="keyword">return</span> context.getResources().getColor(id);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>而我们定义的 attr 颜色值, 是直接和主题 theme 相关的. 因此在早于 5.0 的版本上, theme 参数没有被逐层传递下去, 相关控件就肯定取不到对应的颜色值. drawable 的问题是类似的.</p>
<p>#又一个坑</p>
<p>这是一个小坑, 或者说, 这是一个我们编程时应避开的错误. 这里一并提出, 以免有小伙伴踩到坑.<br>本文讨论的 attr 资源, 因为都是和主题直接相关的, 因此一定要注意, 不同的 Context 获取到的资源会有不同!<br>比如有时候我们为了方便, 在应用全局保存了一个 Application 的实例, 这样就可以用静态方法取到颜色等资源. 比如有以下简单的帮助类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceUtils</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Application sApp;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Resources sRes;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ResourceUtils</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Application app)</span> </span>&#123;</div><div class="line">        sApp = app;</div><div class="line">        sRes = app.getResources();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getString</span><span class="params">(<span class="keyword">int</span> resId)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sRes.getString(resId);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getColor</span><span class="params">(<span class="keyword">int</span> resId)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sRes.getColor(resId);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面这个类可以在 Application.onCreate() 里面初始化, 然后就可以愉快的以静态方法获取资源了.<br>但用这种方法, 是在用 ApplicationContext 获取资源, 其行为和用 Activity 的 Context 获取资源会有不同, 在资源和主题 theme 相关联时, 其取到的资源也会不同. 具体请学习 ContextWrapper 相关知识 (博主还没来得及细研究, 就不展开写了, 以免误导大家…) .<br>因此 <strong>取和主题相关的资源时, 尽量用当前 Activity 的 Context</strong> 就是了.</p>
<hr>
<blockquote>
<p>参考:<br><a href="https://code.google.com/p/android/issues/detail?id=26251" target="_blank" rel="external">google code issue</a><br><a href="http://stackoverflow.com/questions/8041537/how-to-reference-style-attributes-from-a-drawable/13471695#13471695" target="_blank" rel="external">stackoverflow question</a><br><a href="http://www.androiddesignpatterns.com/2016/08/contextcompat-getcolor-getdrawable.html" target="_blank" rel="external">Styling Colors &amp; Drawables w/ Theme Attributes</a></p>
</blockquote>
<hr>
<p>原创文章, 转载请注明出处. 原载 <a href="https://liuxu0703.github.io/">https://liuxu0703.github.io/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://liuxu0703.github.io/2017/03/09/ubuntu-adb-recognise/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lyux">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="What a Chance to Learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/09/ubuntu-adb-recognise/" itemprop="url">Ubuntu 下使用 ADB 调试 Android 应用时的设备识别问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-09T00:45:43+08:00">
                2017-03-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/09/ubuntu-adb-recognise/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2017/03/09/ubuntu-adb-recognise/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在 Ubuntu 下使用 Android ADB 调试时如果出现错误提示:<br><code>insufficient permissions for device: verify udev rules</code><br>等等… 以及各种各样的奇怪问题, 总之就是不能用或不好用.<br>这都可能是 udev rules 问题. 可以优先尝试如下解决方案:</p>
<p>#udev rules</p>
<p>这是谷歌官方给出的 Ubuntu 下使用 ADB 调试的配置方法, <a href="https://developer.android.com/studio/run/device.html" target="_blank" rel="external">链接在此</a> (需翻墙) .<br>只说说其具体操作步骤:</p>
<ul>
<li><p>首先, 以 root 权限创建文件 <code>/etc/udev/rules.d/51-android.rules</code> .</p>
<p>  <code>$ sudo touch /etc/udev/rules.d/51-android.rules</code></p>
</li>
<li><p>然后, 为每个制造商创建一条规则.<br><code>SUBSYSTEM==&quot;usb&quot;, ATTR{idVendor}==&quot;0bb4&quot;, MODE=&quot;0666&quot;, GROUP=&quot;plugdev&quot;</code><br>上面这条规则中的 vendor ID 是 HTC 的. <code>MODE</code> 参数指定了读写权限; <code>GROUP</code> 属性指定设备节点的拥有组.<br>编辑 <code>/etc/udev/rules.d/51-android.rules</code> 文件. 如果这个文件是空的, 就加入这条规则. 如果有内容, 就把这行追加到文件最后.</p>
</li>
</ul>
<ul>
<li><p>最后, 为该文件增加读权限:</p>
<p>  <code>$ chmod a+r /etc/udev/rules.d/51-android.rules</code></p>
</li>
<li><p>最最后, 重新插拔手机, 就可以愉快的调试了.</p>
</li>
</ul>
<blockquote>
<p>并非所有的手机都需要走上面这一套才可以调试. 具体啥样的手机需要这样做, 我就不知道了…<br>总之 Ubuntu 下遇到 ADB 有问题时, 可以优先尝试以上解决办法.</p>
</blockquote>
<p>#设备制造商 Vendor ID</p>
<p>这张表是谷歌官方给出的, 里面的数据就是填写在 <code>ATTR{idVendor}</code> 属性中各个制造商的 idVendor 的值.</p>
<table>
<thead>
<tr>
<th>Company</th>
<th>USB Vendor ID</th>
</tr>
</thead>
<tbody>
<tr>
<td>Acer</td>
<td>0502 </td>
</tr>
<tr>
<td>ASUS</td>
<td>0b05</td>
</tr>
<tr>
<td>Dell</td>
<td>413c</td>
</tr>
<tr>
<td>Foxconn</td>
<td>0489</td>
</tr>
<tr>
<td>Fujitsu</td>
<td>04c5</td>
</tr>
<tr>
<td>Fujitsu Toshiba</td>
<td>04c5</td>
</tr>
<tr>
<td>Garmin-Asus</td>
<td>091e</td>
</tr>
<tr>
<td>Google</td>
<td>18d1</td>
</tr>
<tr>
<td>Haier</td>
<td>201E</td>
</tr>
<tr>
<td>Hisense</td>
<td>109b</td>
</tr>
<tr>
<td>HP</td>
<td>03f0</td>
</tr>
<tr>
<td>HTC</td>
<td>0bb4</td>
</tr>
<tr>
<td>Huawei</td>
<td>12d1</td>
</tr>
<tr>
<td>Intel</td>
<td>8087</td>
</tr>
<tr>
<td>K-Touch</td>
<td>24e3</td>
</tr>
<tr>
<td>KT Tech</td>
<td>2116</td>
</tr>
<tr>
<td>Kyocera</td>
<td>0482</td>
</tr>
<tr>
<td>Lenovo</td>
<td>17ef</td>
</tr>
<tr>
<td>LG</td>
<td>1004</td>
</tr>
<tr>
<td>Motorola</td>
<td>22b8</td>
</tr>
<tr>
<td>MTK</td>
<td>0e8d</td>
</tr>
<tr>
<td>NEC</td>
<td>0409</td>
</tr>
<tr>
<td>Nook</td>
<td>2080</td>
</tr>
<tr>
<td>Nvidia</td>
<td>0955</td>
</tr>
<tr>
<td>OTGV</td>
<td>2257</td>
</tr>
<tr>
<td>Pantech</td>
<td>10a9</td>
</tr>
<tr>
<td>Pegatron</td>
<td>1d4d</td>
</tr>
<tr>
<td>Philips</td>
<td>0471</td>
</tr>
<tr>
<td>PMC-Sierra</td>
<td>04da</td>
</tr>
<tr>
<td>Qualcomm</td>
<td>05c6</td>
</tr>
<tr>
<td>SK Telesys</td>
<td>1f53</td>
</tr>
<tr>
<td>Samsung</td>
<td>04e8</td>
</tr>
<tr>
<td>Sharp</td>
<td>04dd</td>
</tr>
<tr>
<td>Sony</td>
<td>054c</td>
</tr>
<tr>
<td>Sony Ericsson</td>
<td>0fce</td>
</tr>
<tr>
<td>Sony Mobile Communications</td>
<td>0fce</td>
</tr>
<tr>
<td>Teleepoch</td>
<td>2340</td>
</tr>
<tr>
<td>Toshiba</td>
<td>0930</td>
</tr>
<tr>
<td>ZTE</td>
<td>19d2</td>
</tr>
</tbody>
</table>
<p><br><br>并非所有(国内)常见制造商都在官方表中被列出. 自己收集了其他常见的 vendor id (持续增加, 欢迎补充):</p>
<table>
<thead>
<tr>
<th>Company</th>
<th>USB Vendor ID</th>
</tr>
</thead>
<tbody>
<tr>
<td>酷派</td>
<td>1ebf</td>
</tr>
<tr>
<td>小米</td>
<td>2717</td>
</tr>
</tbody>
</table>
<p>#lsusb</p>
<p>这个 idVendor 的值也可以通过 lsusb 命令查看到.<br>博主自用的电脑上, 没插任何 USB 设备时, 这个命令输出如下:</p>
<pre><code>$ lsusb
Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 001 Device 004: ID 5986:0708 Acer, Inc 
Bus 001 Device 003: ID 8087:0a2b Intel Corp. 
Bus 001 Device 002: ID 138a:0090 Validity Sensors, Inc. 
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
</code></pre><p>以第一条输出为例进行说明:</p>
<pre><code>Bus 002 : 指明设备连接到哪 (哪条总线)
Device 001 : 表明这是连接到总线上的第一台设备
ID 1d6b:0003 : 设备的ID. 1d6b 是生产商ID (我们就是要这个), 0003 是产品ID
Linux Foundation 3.0 : 生产商
root hub : 设备名
</code></pre><p>博主手头有一部古老的酷派手机, 直接链接 Android Studio 总是无法调试. 而谷歌大大的表里又没有酷派的 Vendor ID, 只能自己找.<br>插上酷派手机后再执行 lsusb, 输出如下:</p>
<pre><code>$ lsusb
Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 001 Device 004: ID 5986:0708 Acer, Inc 
Bus 001 Device 003: ID 8087:0a2b Intel Corp. 
Bus 001 Device 002: ID 138a:0090 Validity Sensors, Inc. 
Bus 001 Device 012: ID 1ebf:7027  
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
</code></pre><p>很明显, 多出来的那条, 就是没写生产商名字和设备名字的那条, 就是酷派手机的信息. (怪不得谷大表里不写, 自己都不上心给自己起个名字)</p>
<pre><code>Bus 001 Device 012: ID 1ebf:7027
</code></pre><p>其中的 1ebf 就是我们要找的 Vendor ID.<br>根据这个 Vendor ID 在 <code>/etc/udev/rules.d/51-android.rules</code> 加入一条规则:</p>
<pre><code>SUBSYSTEM==&quot;usb&quot;, ATTR{idVendor}==&quot;1ebf&quot;, MODE=&quot;0666&quot;, GROUP=&quot;plugdev&quot;
</code></pre><p>然后重新插拔手机, 再次使用 Android Studio 调试, 就可以正常使用了.</p>
<p>#我的 udev rule 文件</p>
<p>自己挑了几个常见的设备商, 都写进 rule list 里了, 免得以后再加麻烦.<br>我的 <code>chmod a+r /etc/udev/rules.d/51-android.rules</code> 文件长这样 (都是为调试 Android 而加入的):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;0bb4&quot;, MODE=&quot;0666&quot;, GROUP=&quot;plugdev&quot;</div><div class="line">SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;18d1&quot;, MODE=&quot;0666&quot;, GROUP=&quot;plugdev&quot;</div><div class="line">SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;201E&quot;, MODE=&quot;0666&quot;, GROUP=&quot;plugdev&quot;</div><div class="line">SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;109b&quot;, MODE=&quot;0666&quot;, GROUP=&quot;plugdev&quot;</div><div class="line">SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;12d1&quot;, MODE=&quot;0666&quot;, GROUP=&quot;plugdev&quot;</div><div class="line">SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;17ef&quot;, MODE=&quot;0666&quot;, GROUP=&quot;plugdev&quot;</div><div class="line">SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;1004&quot;, MODE=&quot;0666&quot;, GROUP=&quot;plugdev&quot;</div><div class="line">SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;22b8&quot;, MODE=&quot;0666&quot;, GROUP=&quot;plugdev&quot;</div><div class="line">SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;0e8d&quot;, MODE=&quot;0666&quot;, GROUP=&quot;plugdev&quot;</div><div class="line">SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;05c6&quot;, MODE=&quot;0666&quot;, GROUP=&quot;plugdev&quot;</div><div class="line">SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;04e8&quot;, MODE=&quot;0666&quot;, GROUP=&quot;plugdev&quot;</div><div class="line">SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;054c&quot;, MODE=&quot;0666&quot;, GROUP=&quot;plugdev&quot;</div><div class="line">SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;0fce&quot;, MODE=&quot;0666&quot;, GROUP=&quot;plugdev&quot;</div><div class="line">SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;19d2&quot;, MODE=&quot;0666&quot;, GROUP=&quot;plugdev&quot;</div><div class="line">SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;8087&quot;, MODE=&quot;0666&quot;, GROUP=&quot;plugdev&quot;</div><div class="line">SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;8087&quot;, MODE=&quot;0666&quot;, GROUP=&quot;plugdev&quot;</div></pre></td></tr></table></figure>
<hr>
<blockquote>
<p><strong>注意:</strong> Android 4.2.2 及以上的设备, 连接 ADB 调试时手机端会有一个授权对话框. 没有在手机端点击确认的话, 也是无法进行调试的. 本文可不是在教大家绕过这个东西.<br>这段说明可能略废话, 但为了不至引起误解, 想象还是加上吧.</p>
</blockquote>
<p><br></p>
<blockquote>
<p>参考:<br><a href="https://developer.android.com/studio/run/device.html" target="_blank" rel="external">Run Apps on a Hardware Device</a><br><a href="http://www.reactivated.net/writing_udev_rules.html" target="_blank" rel="external">writing udev rules</a></p>
</blockquote>
<hr>
<p>原创文章, 转载请注明出处. 原载 <a href="https://liuxu0703.github.io/">https://liuxu0703.github.io/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Lyux" />
          <p class="site-author-name" itemprop="name">Lyux</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/rss2.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lyux</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	

		<script type="text/javascript">
		_hcwp = window._hcwp || [];

		_hcwp.push({widget:"Bloggerstream", widget_id: 93567, selector:".hc-comment-count", label: "{\%COUNT%\}" });

		

		(function() {
		if("HC_LOAD_INIT" in window)return;
		HC_LOAD_INIT = true;
		var lang = (navigator.language || navigator.systemLanguage || navigator.userLanguage || "en").substr(0, 2).toLowerCase();
		var hcc = document.createElement("script"); hcc.type = "text/javascript"; hcc.async = true;
		hcc.src = ("https:" == document.location.protocol ? "https" : "http")+"://w.hypercomments.com/widget/hc/93567/"+lang+"/widget.js";
		var s = document.getElementsByTagName("script")[0];
		s.parentNode.insertBefore(hcc, s.nextSibling);
		})();
		</script>

	










  





  

  

  

  

  

  

</body>
</html>
